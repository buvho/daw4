<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
  <title>Editor de Perguntas</title>
</head>
<body class="p-4">
  <div class="container">
    <h2>Lista de Perguntas</h2>
    <table class="table table-striped mt-3">
      <thead>
        <tr>
          <th>Pergunta</th>
          <th>Tipo</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tabela"></tbody>
    </table>
  </div>

  <div class="modal fade" id="editModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content p-3">
        <h5>Editar Pergunta</h5>
        <input type="hidden" id="editId">
        <input type="hidden" id="editTipo">
        
        <div class="form-group">
          <label>Pergunta</label>
          <input type="text" id="editPergunta" class="form-control">
        </div>

        <div id="alternativasContainer" style="display:none;">
          <label>Alternativas:</label>
          <div id="alts"></div>
          <label class="mt-2">Resposta Correta (número da alternativa)</label>
          <input type="number" id="editCorreta" min="1" class="form-control">
        </div>

        <button id="salvar" class="btn btn-success mt-3">Salvar</button>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  const tabela = document.getElementById("tabela");

  function carregarPerguntas() {
    fetch('listar.php')
      .then(r => r.json())
      .then(perguntas => {
        tabela.innerHTML = '';
        perguntas.forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.pergunta}</td>
            <td>${p.tipo}</td>
            <td><button class="btn btn-info btn-sm" onclick='abrirModal(${JSON.stringify(p)})'>Editar</button></td>`;
          tabela.appendChild(tr);
        });
      });
  }

  function abrirModal(p) {
    document.getElementById("editId").value = p.id;
    document.getElementById("editPergunta").value = p.pergunta;
    document.getElementById("editTipo").value = p.tipo;

    const container = document.getElementById("alternativasContainer");
    const altsDiv = document.getElementById("alts");
    altsDiv.innerHTML = "";

    if (p.tipo.toLowerCase() === "multipla") {
      container.style.display = "block";
      p.alternativas.forEach((alt, i) => {
        const input = document.createElement("input");
        input.type = "text";
        input.value = alt;
        input.className = "form-control mb-1";
        input.placeholder = `Alternativa ${i + 1}`;
        input.dataset.index = i;
        altsDiv.appendChild(input);
      });
      document.getElementById("editCorreta").value = p.correta;
    } else {
      container.style.display = "none";
    }

    $('#editModal').modal('show');
  }

  document.getElementById("salvar").addEventListener("click", () => {
    const id = document.getElementById("editId").value;
    const pergunta = document.getElementById("editPergunta").value;
    const tipo = document.getElementById("editTipo").value;

    let payload = { id, pergunta };

    if (tipo.toLowerCase() === "multipla") {
      const alternativas = Array.from(document.querySelectorAll("#alts input")).map(i => i.value);
      const correta = document.getElementById("editCorreta").value;
      payload.alternativas = alternativas;
      payload.correta = correta;
    }

    fetch('editar.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(res => {
      if (res.sucesso) {
        alert("Pergunta atualizada!");
        $('#editModal').modal('hide');
        carregarPerguntas();
      } else {
        alert("Erro: " + (res.erro || "desconhecido"));
      }
    });
  });

  carregarPerguntas();
  </script>
</body>
</html>
